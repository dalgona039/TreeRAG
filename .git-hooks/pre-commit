#!/bin/bash

RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "ğŸ” Checking for sensitive information..."

PATTERNS=(
    "AIza[0-9A-Za-z_-]{35}"
    "sk-[0-9A-Za-z]{48}"
    "ghp_[0-9A-Za-z]{36}"
    "gho_[0-9A-Za-z]{36}"
    "AKIA[0-9A-Z]{16}"
    "[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"
    "password\s*=\s*['\"][^'\"]{8,}['\"]" 
    "api_key\s*=\s*['\"][^'\"]+['\"]" 
    "secret\s*=\s*['\"][^'\"]+['\"]" 
    "token\s*=\s*['\"][^'\"]+['\"]" 
)

PATTERN_NAMES=(
    "Google API Key"
    "OpenAI API Key"
    "GitHub Personal Access Token"
    "GitHub OAuth Token"
    "AWS Access Key"
    "UUID (potential key)"
    "Password"
    "API Key"
    "Secret"
    "Token"
)

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

FOUND_ISSUES=0

for file in $STAGED_FILES; do
    if file "$file" | grep -q "text"; then
        i=0
        for pattern in "${PATTERNS[@]}"; do
            if grep -qE "$pattern" "$file" 2>/dev/null; then
                echo -e "${RED}âŒ BLOCKED: ${PATTERN_NAMES[$i]} detected in $file${NC}"
                FOUND_ISSUES=1
                
                grep -nE "$pattern" "$file" | while read -r line; do
                    line_num=$(echo "$line" | cut -d: -f1)
                    echo -e "${YELLOW}   Line $line_num: [REDACTED]${NC}"
                done
            fi
            ((i++))
        done
    fi
done

if echo "$STAGED_FILES" | grep -qE "\.env$|\.env\.local$|\.env\.production$"; then
    echo -e "${RED}âŒ BLOCKED: .env file detected in commit${NC}"
    echo -e "${YELLOW}   Files: $(echo "$STAGED_FILES" | grep -E "\.env")${NC}"
    FOUND_ISSUES=1
fi

if echo "$STAGED_FILES" | grep -q "secrets/"; then
    echo -e "${RED}âŒ BLOCKED: secrets/ directory files detected${NC}"
    FOUND_ISSUES=1
fi

if [ $FOUND_ISSUES -eq 1 ]; then
    echo ""
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}ğŸš« COMMIT BLOCKED: Sensitive information detected${NC}"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "To fix:"
    echo "  1. Remove sensitive information from staged files"
    echo "  2. Add to .gitignore if necessary"
    echo "  3. Use environment variables instead"
    echo "  4. Check SECURITY.md for best practices"
    echo ""
    echo "To bypass this check (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi

echo "âœ… No sensitive information detected"
exit 0
